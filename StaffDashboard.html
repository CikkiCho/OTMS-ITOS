<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Dashboard - OT Management System</title>
  <?!= include('Styles'); ?>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-container">
      <div class="navbar-brand">
        üìä OT Management System
      </div>
      <ul class="navbar-nav">
        <li><a href="?page=dashboard" class="nav-link active">Dashboard</a></li>
        <li><a href="?page=apply" class="nav-link">Apply OT</a></li>
        <li><a href="?page=history" class="nav-link">History</a></li>
      </ul>
      <div style="color: white;">
        üë§ <?= userData.staffName ?>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="text-center">
      <div class="spinner"></div>
      <p style="margin-top: 1rem; color: #666;">Loading dashboard...</p>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard" class="hidden">
      <!-- Welcome Section -->
      <div class="card">
        <h2>Welcome, <span id="staffName"></span>! üëã</h2>
        <p style="color: #666;">Team: <span id="teamName"></span></p>
      </div>

      <!-- OT Summary Stats -->
      <div class="grid grid-3 mb-3">
        <div class="stat-card blue">
          <div class="stat-label">Total OT This Month</div>
          <div class="stat-value" id="totalHours">0</div>
          <div class="stat-label">hours / 104 hours</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">Money Claim</div>
          <div class="stat-value" id="moneyHours">0</div>
          <div class="stat-label">hours</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);">
          <div class="stat-label">Leave Earned</div>
          <div class="stat-value" id="leaveDays">0</div>
          <div class="stat-label">days</div>
        </div>
      </div>

      <!-- OT Limit Progress -->
      <div class="card">
        <div class="card-header">
          <span>Monthly OT Limit</span>
          <span id="limitStatus"></span>
        </div>
        <div class="card-body">
          <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%">
              <span id="progressText">0 / 104 hours</span>
            </div>
          </div>
          <p class="form-text mt-2" id="remainingHours"></p>
        </div>
      </div>

      <!-- Application Status -->
      <div class="card">
        <div class="card-header">
          <span>Application Status</span>
          <a href="?page=apply" class="btn btn-primary">‚ûï New Application</a>
        </div>
        <div class="card-body">
          <div class="grid grid-2">
            <div style="text-align: center; padding: 1rem; background: #FFF3CD; border-radius: 8px;">
              <div style="font-size: 2rem; font-weight: bold; color: #856404;" id="pendingCount">0</div>
              <div style="color: #856404;">Pending Approval</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #D4EDDA; border-radius: 8px;">
              <div style="font-size: 2rem; font-weight: bold; color: #155724;" id="approvedCount">0</div>
              <div style="color: #155724;">Approved</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #F8D7DA; border-radius: 8px;">
              <div style="font-size: 2rem; font-weight: bold; color: #721C24;" id="rejectedCount">0</div>
              <div style="color: #721C24;">Rejected</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #E2E3E5; border-radius: 8px;">
              <div style="font-size: 2rem; font-weight: bold; color: #383D41;" id="draftCount">0</div>
              <div style="color: #383D41;">Draft</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Applications -->
      <div class="card">
        <div class="card-header">
          <span>Recent OT Applications</span>
          <a href="?page=history" class="btn btn-secondary">View All</a>
        </div>
        <div class="card-body">
          <div id="recentApplications">
            <!-- Populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden">
      <div class="alert alert-danger">
        <strong>Error!</strong> <span id="errorMessage"></span>
      </div>
    </div>
  </div>

  <?!= include('Scripts'); ?>

  <script>
    // Load dashboard data on page load
    window.onload = function() {
      loadDashboard();
    };

    function loadDashboard() {
      google.script.run
        .withSuccessHandler(onDashboardLoaded)
        .withFailureHandler(onDashboardError)
        .apiGetStaffDashboard();
    }

    function onDashboardLoaded(data) {
      console.log('Dashboard data:', data);
      
      if (!data.success) {
        showErrorState(data.message);
        return;
      }

      // Hide loading, show dashboard
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');

      // Populate staff info
      document.getElementById('staffName').textContent = data.staffEmail;
      document.getElementById('teamName').textContent = '<?= userData.team ?>';

      // Populate summary stats
      const summary = data.summary || {
        totalOTHours: 0,
        moneyClaimHours: 0,
        leaveClaimHours: 0,
        leaveDaysEarned: 0,
        status: 'Green'
      };

      document.getElementById('totalHours').textContent = summary.totalOTHours;
      document.getElementById('moneyHours').textContent = summary.moneyClaimHours;
      document.getElementById('leaveDays').textContent = summary.leaveDaysEarned;

      // Update progress bar
      const progress = calculateProgress(summary.totalOTHours, APP_CONFIG.maxOTHours);
      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = progress + '%';
      progressBar.className = 'progress-bar ' + getProgressClass(progress);
      document.getElementById('progressText').textContent = 
        `${summary.totalOTHours} / ${APP_CONFIG.maxOTHours} hours`;

      // Update limit status
      document.getElementById('limitStatus').innerHTML = getOTStatusBadge(summary.status);
      
      // Update remaining hours
      const remaining = data.limits.remainingHours;
      let remainingText = `You have ${remaining} hours remaining this month.`;
      if (remaining < 15) {
        remainingText = `‚ö†Ô∏è Only ${remaining} hours remaining!`;
      }
      document.getElementById('remainingHours').textContent = remainingText;

      // Populate status counts
      document.getElementById('pendingCount').textContent = data.statusCounts.pending;
      document.getElementById('approvedCount').textContent = data.statusCounts.approved;
      document.getElementById('rejectedCount').textContent = data.statusCounts.rejected;
      document.getElementById('draftCount').textContent = data.statusCounts.draft;

      // Populate recent applications
      populateRecentApplications(data.applications);
    }

    function populateRecentApplications(applications) {
      const container = document.getElementById('recentApplications');
      
      if (!applications || applications.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No applications yet. Click "New Application" to submit your first OT claim.</p>';
        return;
      }

      // Show latest 5 applications
      const recent = applications.slice(0, 5);
      
      let html = '<div class="table-responsive"><table class="table">';
      html += '<thead><tr>';
      html += '<th>Date</th>';
      html += '<th>Time</th>';
      html += '<th>Hours</th>';
      html += '<th>Type</th>';
      html += '<th>Status</th>';
      html += '<th>Submitted</th>';
      html += '</tr></thead><tbody>';

      recent.forEach(app => {
        html += '<tr>';
        html += `<td>${formatDate(app.otDate)}</td>`;
        html += `<td>${parseTimeString(app.startTime)} - ${parseTimeString(app.endTime)}</td>`;
        html += `<td><strong>${app.totalHours}h</strong>${app.isPublicHoliday ? ' <span style="color: #9C27B0;">‚≠ê PH</span>' : ''}</td>`;
        html += `<td>${app.claimType}</td>`;
        html += `<td>${getStatusBadge(app.status)}</td>`;
        html += `<td>${formatDateTime(app.submittedDate)}</td>`;
        html += '</tr>';
        
        // Show validation warnings if any
        if (app.validationErrors && app.status === 'Pending') {
          html += '<tr>';
          html += `<td colspan="6" style="background: #FFF3CD; padding: 0.5rem;">`;
          html += `<small>‚ö†Ô∏è ${app.validationErrors}</small>`;
          html += '</td>';
          html += '</tr>';
        }
        
        // Show remarks if approved/rejected
        if (app.remarks && (app.status === 'Approved' || app.status === 'Rejected')) {
          html += '<tr>';
          html += `<td colspan="6" style="background: #f9f9f9; padding: 0.5rem;">`;
          html += `<small><strong>Remarks:</strong> ${app.remarks}</small>`;
          html += '</td>';
          html += '</tr>';
        }
      });

      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function onDashboardError(error) {
      showErrorState(error.message || 'Failed to load dashboard');
    }

    function showErrorState(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = message;
    }
  </script>
</body>
</html>
