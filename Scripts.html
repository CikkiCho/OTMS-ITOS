<!-- Common JavaScript functions for all pages -->
<script>
  // Global configuration
  const APP_CONFIG = {
    maxOTHours: 104,
    warningThreshold: 90,
    hoursPerLeaveDay: 6
  };

  // Show loading spinner
  function showLoading(message = 'Loading...') {
    const loadingHtml = `
      <div style="text-align: center; padding: 2rem;">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; color: #666;">${message}</p>
      </div>
    `;
    return loadingHtml;
  }

  // Show error message
  function showError(message) {
    return `<div class="alert alert-danger">${message}</div>`;
  }

  // Show success message
  function showSuccess(message) {
    return `<div class="alert alert-success">${message}</div>`;
  }

  // Show warning message
  function showWarning(message) {
    return `<div class="alert alert-warning">${message}</div>`;
  }

  // Format date
  function formatDate(date) {
    if (!date) return '';
    const d = new Date(date);
    return d.toLocaleDateString('en-MY', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }

  // Format datetime
  function formatDateTime(date) {
    if (!date) return '';
    const d = new Date(date);
    return d.toLocaleString('en-MY', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Format time
  function formatTime(time) {
    if (!time) return '';
    if (typeof time === 'string') return time;
    const d = new Date(time);
    return d.toLocaleTimeString('en-MY', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Get status badge HTML
  function getStatusBadge(status) {
    const statusMap = {
      'Pending': 'badge-pending',
      'Approved': 'badge-approved',
      'Rejected': 'badge-rejected',
      'Draft': 'badge-draft'
    };
    const className = statusMap[status] || 'badge-draft';
    return `<span class="badge ${className}">${status}</span>`;
  }

  // Get OT status badge
  function getOTStatusBadge(status) {
    const statusMap = {
      'Green': 'badge-green',
      'Amber': 'badge-amber',
      'Red': 'badge-red'
    };
    const className = statusMap[status] || 'badge-green';
    return `<span class="badge ${className}">${status}</span>`;
  }

  // Calculate progress percentage
  function calculateProgress(current, max) {
    return Math.min((current / max) * 100, 100);
  }

  // Get progress bar class
  function getProgressClass(percentage) {
    if (percentage >= 100) return 'red';
    if (percentage >= 86.5) return 'amber'; // 90/104
    return '';
  }

  // Show modal
  function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add('show');
    }
  }

  // Hide modal
  function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove('show');
    }
  }

  // Show toast notification
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type}`;
    toast.style.position = 'fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.style.minWidth = '300px';
    toast.style.animation = 'slideIn 0.3s';
    toast.innerHTML = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s';
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }

  // Validate form
  function validateForm(formId) {
    const form = document.getElementById(formId);
    if (!form) return false;
    
    let isValid = true;
    const requiredFields = form.querySelectorAll('[required]');
    
    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        field.classList.add('error');
        isValid = false;
      } else {
        field.classList.remove('error');
      }
    });
    
    return isValid;
  }

  // Disable button
  function disableButton(buttonId) {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = true;
      button.innerHTML = '<span class="spinner" style="width: 20px; height: 20px;"></span> Processing...';
    }
  }

  // Enable button
  function enableButton(buttonId, originalText) {
    const button = document.getElementById(buttonId);
    if (button) {
      button.disabled = false;
      button.innerHTML = originalText;
    }
  }

  // Handle API errors
  function handleApiError(error) {
    console.error('API Error:', error);
    showToast('An error occurred. Please try again.', 'danger');
  }

  // Confirm action
  function confirmAction(message) {
    return confirm(message);
  }

  // Get current month-year
  function getCurrentMonthYear() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    return `${year}-${month}`;
  }

  // Parse time string to display format
  function parseTimeString(timeStr) {
    if (!timeStr) return '';
    // Handle HH:MM:SS format
    const parts = timeStr.split(':');
    if (parts.length >= 2) {
      return `${parts[0]}:${parts[1]}`;
    }
    return timeStr;
  }

  // Calculate duration between two times
  function calculateDuration(startTime, endTime) {
    if (!startTime || !endTime) return 0;
    
    const start = startTime.split(':');
    const end = endTime.split(':');
    
    const startMinutes = parseInt(start[0]) * 60 + parseInt(start[1]);
    let endMinutes = parseInt(end[0]) * 60 + parseInt(end[1]);
    
    // Handle overnight
    if (endMinutes < startMinutes) {
      endMinutes += 24 * 60;
    }
    
    const durationMinutes = endMinutes - startMinutes;
    return (durationMinutes / 60).toFixed(2);
  }

  // Reload page
  function reloadPage() {
    window.location.reload();
  }

  // Navigate to page
  function navigateTo(page) {
    window.location.href = `?page=${page}`;
  }

  // Export to CSV
  function exportToCSV(data, filename) {
    const csv = convertToCSV(data);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
  }

  // Convert array to CSV
  function convertToCSV(data) {
    if (!data || data.length === 0) return '';
    
    const headers = Object.keys(data[0]);
    const rows = data.map(obj => 
      headers.map(header => JSON.stringify(obj[header] || '')).join(',')
    );
    
    return [headers.join(','), ...rows].join('\n');
  }

  // Add CSS animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(style);
</script>
